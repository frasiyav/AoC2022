âŸ¨lf, Split, ToNumsâŸ© â† â€¢Import "bqn-libs/strings.bqn"
âŸ¨HashMapâŸ© â† â€¢Import "bqn-libs/hashmap.bqn"
While â† {ğ•©â€¢_while_ğ•¨@}Â´

jets â† 1âŒŠ'<'-ËœÂ¯1â†“â€¢file.Chars"input17.txt"

shapes â† âŸ¨
  [1â€¿1â€¿1â€¿1]
  [0â€¿1â€¿0,1â€¿1â€¿1,0â€¿1â€¿0]
  [0â€¿0â€¿1,0â€¿0â€¿1,1â€¿1â€¿1]
 â‰[1â€¿1â€¿1â€¿1]
  [1â€¿1,1â€¿1]
âŸ©

Position â† {hâ€¿wâ†â‰¢ğ•© â‹„ Â»Ë˜9â†‘Ë˜âŸ¨3+h,-2+wâŸ©â†‘ğ•©}
shapes PositionÂ¨â†©

Extend â† 1Â«Ë˜Â·Â»Ë˜1Â»Ë˜0Ã—âŠ¢
TrimTop â† (âŠ‘âˆ˜/2<+Â´Ë˜)âŠ¸â†“
Blocked â† (+â—‹(+Â´)â‰ Â·+Â´âˆ¨)â—‹â¥Š
_shift â† {ğ•¨ Â¬âˆ˜Blocked nâ†ğ”½Ë˜ğ•©? n; ğ•©}
_Push â† {ğ”½â—¶âŸ¨Â«_shift,Â»_shiftâŸ©}

init â† âŸ¨0, 0, 0, 1â€¿9â¥Š1âŸ©

Drop â† { ğ•Š âŸ¨h, piececount, jetindex, gridâŸ©:
  piece â† shapes âŠ‘Ëœ 5|piececount
  g â† (Extend piece) âˆ¾ grid
  p â† piece âˆ¾ 0Ã—grid
  moving â† 1
  While {ğ•Š:moving}â€¿{ğ•Š:
    p â†© g (jetindexâŠ‘jets)_Push p
    jetindex ((â‰ jets)|+)â†©1
    g Â¬âˆ˜Blocked nâ†Â»p? pâ†©n;
    g+â†©p â‹„ movingâ†©0
  }
  g TrimTopâ†©
  âŸ¨h+g-â—‹â‰ grid, 1+piececount, jetindex, 40â†‘gâŸ©
}

# Part 1
â€¢Show âŠ‘ DropâŸ2022 init

# Part 2
cache â† HashmapËœâŸ¨âŸ©
cycleâ†@ â‹„ found â† 0
state â† init
While {ğ•Š:Â¬found}â€¿{ğ•Š:
  state Dropâ†©
  {cache.Has ğ•©?
    cycle â†© (cache.Getğ•©)âˆ¾2â†‘state
    found â†© 1
  ;
    ğ•© cache.Set 2â†‘state
  } 5âŠ¸|âŒ¾âŠ‘ 1â†“state
}

n â† 1_000_000_000_000
cstarthâ€¿cstartâ€¿cendhâ€¿cend â† cycle
clen â† cend - cstart
cheight â† cendh - cstarth
repeatsâ€¿remainder â† clen (âŒŠâˆ˜Ã·Ëœâ‹ˆ|) n-cstart
â€¢Show (cheight Ã— repeats) + âŠ‘ DropâŸ(cstart+remainder) init
